<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品詳情 - Treat Trader</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .product-main { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
        .tab-btn-group { display: flex; gap: 5px; }
        .tab-btn { flex: 1; padding: 12px; background: #FFECB3; border: none; cursor: pointer; font-weight: bold; border-radius: 10px 10px 0 0; }
        .tab-btn.active { background: #FFD2A6; color: #5C4033; }
        .tab-content { background: white; padding: 20px; display: none; border-radius: 0 0 10px 10px; margin-bottom: 20px; }
        .tab-content.active { display: block; }
        .review-input-area { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .review-input-area textarea { width: 100%; height: 80px; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .review-input-area textarea:disabled { background: #f5f5f5; cursor: not-allowed; }
        .star-rating-input { display: flex; gap: 5px; font-size: 1.5rem; cursor: pointer; }
        .star-rating-input span { color: #ccc; transition: 0.2s; }
        .star-rating-input span.active { color: #e2b007; }
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .page-num { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #ddd; cursor: pointer; }
        .page-num.active { background: #FF7F50; color: white; border-color: #FF7F50; }
        .pagination {display: flex;justify-content: center;gap: 8px;margin-top: 20px;}
        .page-num {padding: 5px 12px;border: 1px solid #ddd;border-radius: 4px;cursor: pointer;user-select: none;}
        .page-num.active {background-color: #5C4033; /* 你的主色調 */color: white;border-color: #5C4033;}
        .page-num:hover:not(.active) {background-color: #f0f0f0;}
        
        @media (max-width: 768px) { .product-main { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="marquee-container">✨ 新年回饋祭最高 10% OFF ｜ 滿 $2500 免運 ｜ 加入會員領取專屬禮券 ✨</div>
    <header>
        <div class="logo" onclick="location.href='index.html'">
            <img src="images/Logo.PNG" alt="Logo">
            Treat Trader
        </div>

        <nav class="main-nav">
            <a href="index.html">首頁</a>
            <a href="allgoods.html">商品總覽</a>
            <a href="member.html">會員資料</a>
            <a href="team.html">關於我們</a>
        </nav>

        <div class="header-icons">
            <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i></a>
            <a href="login.html" id="avatarLink"><i class="fa-solid fa-circle-user"></i></a>
        </div>
    </header>
    
    <div class="container">
        <div class="product-main">
            <div id="pImg" class="card" style="height:400px; background:#eee; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:#888;" id="pImg"></div>
            <div>
                <h1 id="pName">載入中...</h1>
                <p id="pPrice" style="font-size: 2rem; color: #FF7F50; margin: 15px 0;">$0</p>
                <div id="pRatingDisplay" style="color: #e2b007; font-size: 1.2rem; margin-bottom: 20px;">★★★★☆ (4.5)</div>
                <div style="display:flex; gap:15px; margin-top: 30px;">
                    <button class="btn" style="flex:1; padding: 15px; font-size:1.1rem;" onclick="addToCart(false)">加入購物車</button>
                    <button class="btn" style="flex:1; background:#5C4033; padding: 15px; font-size:1.1rem;" onclick="addToCart(true)">直接購買</button>
                </div>
            </div>
        </div>

        <div class="tab-btn-group">
            <button class="tab-btn active" onclick="switchTab(event, 'intro')">商品簡介</button>
            <button class="tab-btn" onclick="switchTab(event, 'nutrition')">營養標示</button>
        </div>
        <div id="intro" class="tab-content active"><h3>商品特色</h3><p id="pDesc">載入中...</p></div>
        <div id="nutrition" class="tab-content"><h3>營養成分</h3><p id="pNut">載入中...</p></div>

        <div class="card" style="margin-bottom: 40px; background: transparent; padding:0; box-shadow: none;">
            <h3 style="margin-bottom: 15px;">商品評價</h3>
            <div id="commentList"></div>
            <div class="pagination"><div class="page-num active">1</div></div>
            <div class="card review-input-area">
                <h4>撰寫評論</h4>
                <div style="margin: 10px 0;">
                    <div class="star-rating-input" id="starContainer">
                        <span onclick="setRating(1)">★</span><span onclick="setRating(2)">★</span><span onclick="setRating(3)">★</span><span onclick="setRating(4)">★</span><span onclick="setRating(5)">★</span>
                    </div>
                </div>
                <textarea id="userReview" placeholder="寫下您對這個商品的看法..."></textarea>
                <button class="btn" id="submitReviewBtn" onclick="submitReview()">送出評論</button>
            </div>
        </div>

        <h3 style="margin: 40px 0 20px;">推薦商品</h3>
        <div id="recList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;"></div>
    </div>

    <div class="scroll-top" onclick="window.scrollTo(0,0)">TOP</div>

    <footer>
        <div class="footer-socials">
            <a href="https://reurl.cc/xKA8ae" target="_blank">
                <i class="fa-brands fa-instagram"></i></a>
            <a href="https://reurl.cc/Vmlo9A" target="_blank">
                <i class="fa-brands fa-threads"></i></a>
            <a href="https://reurl.cc/9ba94j" target="_blank">
                <i class="fa-brands fa-line"></i></a>
            <a href="mailto:service@example.com">
                <i class="fa-solid fa-envelope"></i></a>
        </div>
        <div class="footer-links"><a href="help.html">幫助中心</a> | <a href="question.html">常見問題</a></div>
        <p class="copyright">© COPYRIGHT 807dorm</p>
    </footer>

    <script>
    const API_BASE = "http://localhost:5038/api";

    var urlParams = new URLSearchParams(window.location.search);
    var pid = urlParams.get('id') || '1';
    var currentProduct = null;
    var currentRating = 5;

    var currentPage = 1;      // 目前頁碼
    var reviewsPerPage = 2;   // 每頁幾筆評論

    // 頁面載入
    window.onload = function () {
        var user = JSON.parse(localStorage.getItem('tt_currentUser'));
        if (user) {
            var avatar = document.getElementById('avatarLink');
            if (avatar) avatar.href = "member.html";
        } else {
            // 未登入：禁止輸入評論
            var reviewInput = document.getElementById('userReview');
            var submitBtn = document.getElementById('submitReviewBtn');
            if (reviewInput) {
                reviewInput.disabled = true;
                reviewInput.placeholder = "請先登入會員以撰寫評論";
            }
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerText = "請先登入";
            }
            var starCont = document.getElementById('starContainer');
            if (starCont) {
                starCont.style.pointerEvents = 'none';
                starCont.style.opacity = '0.5';
            }
        }

        // 預設 5 星
        setRating(5);

        // 讀取商品資料
        fetch('products.json')
            .then(function (res) { return res.json(); })
            .then(function (data) {
                currentProduct = data.find(function (p) { return p.id == pid; });
                if (currentProduct) {
                    document.getElementById('pName').innerText = currentProduct.name;
                    document.getElementById('pPrice').innerText = '$' + currentProduct.price;
                    document.getElementById('pDesc').innerText = currentProduct.desc;
                    document.getElementById('pNut').innerText = currentProduct.nutrition;

                    var imgContainer = document.getElementById('pImg');
                    var imagePath = "images/" + currentProduct.img;
                    var imgHtml = '<img src="' + imagePath + '" alt="' + currentProduct.name + '" style="width:100%; height:100%; object-fit:cover; border-radius:10px;">';
                    imgContainer.innerHTML = imgHtml;
                    imgContainer.style.background = "none";

                    // 載入評論 & 推薦商品
                    loadReviews();
                    loadRecs(data);
                }
            });
    };

    // 推薦商品
    function loadRecs(all) {
        var recs = all.filter(function (p) { return p.id != pid; }).slice(0, 4);
        var recList = document.getElementById("recList");
        if (!recList) return;

        recList.innerHTML = recs.map(function (p) {
            var recImgPath = "images/" + p.img;
            return '' +
                '<div class="card" style="text-align:center; cursor:pointer;" onclick="location.href=\'goods.html?id=' + p.id + '\'">' +
                    '<div style="height:150px; margin-bottom:10px; overflow:hidden; border-radius:10px; background:#f9f9f9;">' +
                        '<img src="' + recImgPath + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display=\'none\'">' +
                    '</div>' +
                    '<h4>' + p.name + '</h4>' +
                    '<p style="color:#FF7F50; font-weight:bold;">$' + p.price + '</p>' +
                '</div>';
        }).join('');
    }

    // 加入購物車
    function addToCart(goCheckout) {
        var user = JSON.parse(localStorage.getItem('tt_currentUser'));
        if (!user) {
            alert("請先登入會員後再進行購物！");
            location.href = "login.html";
            return;
        }
        if (!currentProduct) return;

        var cart = JSON.parse(localStorage.getItem('tt_cart') || "[]");
        var item = cart.find(function (i) { return i.id == pid; });
        if (item) item.qty++;
        else cart.push({ id: pid, qty: 1, name: currentProduct.name, price: currentProduct.price });

        localStorage.setItem('tt_cart', JSON.stringify(cart));
        if (goCheckout) location.href = 'cart.html';
        else alert("已加入購物車！");
    }

    // 上方星等選擇
    function setRating(val) {
        currentRating = val;
        var starContainer = document.getElementById('starContainer');
        if (!starContainer) return;

        var stars = starContainer.children;
        for (var i = 0; i < stars.length; i++) {
            if (i < val) stars[i].classList.add('active');
            else stars[i].classList.remove('active');
        }
    }

    // 預設假評論（商品頁一開始就看得到的那種）
    function getFakeReviewsForProduct() {
        return [
            { userName: "柳葉瑜", rating: 5, date: "2025/12/20", content: "出貨速度超級快，包裝也很完整！下次一定會再回購，大推！" },
            { userName: "陳淑美", rating: 4, date: "2026/01/01", content: "整體來說很滿意，但是物流稍微慢了一點點，扣一顆星。食物本身沒問題，很好粗。" },
            { userName: "丁希望", rating: 5, date: "2025/12/25", content: "這是我最喜歡的零食，台灣能買到真的太好了。客服人員也非常親切有耐心。" },
            { userName: "潔西卡比獸", rating: 3, date: "2025/01/10", content: "跟圖片實物有點誤差，不過還可以接受。" },
            { userName: "強哥", rating: 5, date: "2026/01/05", content: "幫家人買的，他們都很喜歡吃。" }
        ];
    }

    // 讀取評論：假評論 + 後端真實評論，一起做前端分頁
    function loadReviews() {
        fetch(API_BASE + "/Reviews/product/" + pid + "?page=1&pageSize=9999")
            .then(function (res) { return res.json(); })
            .then(function (data) {
                var realReviews = data.items || []; // 後端回來的真實評論
                var allReviews = getFakeReviewsForProduct().concat(realReviews);

                // 依日期排序（新到舊）
                allReviews.sort(function (a, b) {
                    var da = new Date(a.date);
                    var db = new Date(b.date);
                    return db - da;
                });

                var totalPages = Math.ceil(allReviews.length / reviewsPerPage);
                if (totalPages === 0) totalPages = 1;
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                var start = (currentPage - 1) * reviewsPerPage;
                var end = start + reviewsPerPage;
                var pageReviews = allReviews.slice(start, end);

                // ✅ 這裡改成你的 id="commentList"
                var container = document.getElementById('commentList');
                if (!container) return;

                if (pageReviews.length === 0) {
                    container.innerHTML = '<p style="padding:10px;">目前尚無評論，快來當第一個評論的人！</p>';
                } else {
                    container.innerHTML = pageReviews.map(function (r) {
                        var stars = '';
                        var rating = r.rating || 0;
                        for (var i = 0; i < 5; i++) {
                            stars += (i < rating ? '★' : '☆');
                        }
                        return '' +
                            '<div class="review-card">' +
                                '<div class="review-header">' +
                                    '<span class="review-user">' + (r.userName || '匿名') + '</span>' +
                                    '<span class="review-date">' + (r.date || '') + '</span>' +
                                '</div>' +
                                '<div class="review-rating">' + stars + '</div>' +
                                '<div class="review-content">' + (r.content || '') + '</div>' +
                            '</div>';
                    }).join('');
                }

                renderPagination(totalPages);
            })
            .catch(function (err) {
                console.error("讀取評論失敗", err);
            });
    }

    // 分頁按鈕
    function renderPagination(totalPages) {
        // ✅ 這裡改成使用你原本的 <div class="pagination">
        var container = document.querySelector('.pagination');
        if (!container) return;

        if (!totalPages || totalPages <= 1) {
            container.innerHTML = "";
            return;
        }

        var html = "";

        // 上一頁
        if (currentPage > 1) {
            html += '<div class="page-num" onclick="changePage(' + (currentPage - 1) + ')">&lt;</div>';
        }

        // 頁碼數字
        for (var i = 1; i <= totalPages; i++) {
            var activeClass = (i === currentPage) ? "active" : "";
            html += '<div class="page-num ' + activeClass + '" onclick="changePage(' + i + ')">' + i + '</div>';
        }

        // 下一頁
        if (currentPage < totalPages) {
            html += '<div class="page-num" onclick="changePage(' + (currentPage + 1) + ')">&gt;</div>';
        }

        container.innerHTML = html;
    }

    // 換頁
    function changePage(page) {
        currentPage = page;
        loadReviews();
    }

    // 送出評論：打後端 API，存進資料庫
    function submitReview() {
        var user = JSON.parse(localStorage.getItem('tt_currentUser'));
        if (!user) {
            alert("請先登入會員再評論！");
            location.href = "login.html";
            return;
        }

        var contentInput = document.getElementById('userReview');
        if (!contentInput) return;

        var content = contentInput.value.trim();
        if (!content) {
            alert("請輸入評論內容");
            return;
        }

        fetch(API_BASE + "/Reviews", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                productId: parseInt(pid),
                userId: user.id,
                userName: user.name,
                rating: currentRating,
                content: content
            })
        })
        .then(function (res) {
            if (!res.ok) return res.json().then(function (err) { throw err; });
            return res.json();
        })
        .then(function () {
            alert("評論已送出！");
            contentInput.value = "";
            currentPage = 1;   // 回到第一頁
            loadReviews();     // 重新載入：會看到新評論 + 預設假評論
        })
        .catch(function (err) {
            alert(err.message || "評論送出失敗");
            console.error(err);
        });
    }

    // tab 切換
    function switchTab(e, id) {
        var tabs = document.querySelectorAll('.tab-btn');
        var contents = document.querySelectorAll('.tab-content');
        for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
        for (var j = 0; j < contents.length; j++) contents[j].classList.remove('active');
        e.currentTarget.classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    // 搜尋相關
    function handleEnter(e) {
        if (e.key === 'Enter') siteSearch();
    }

    function siteSearch() {
        var input = document.getElementById('globalSearch');
        if (!input) return;

        var val = input.value.trim();
        if (!val) return;

        fetch('products.json')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                var matches = data.filter(function (p) { return p.name.includes(val); });
                if (matches.length === 0) alert("沒有搜尋到相關商品！");
                else location.href = "allgoods.html?search=" + encodeURIComponent(val);
            });
    }

    function handleSearchInput(input) {
        var val = input.value.toLowerCase();
        var box = document.getElementById('searchSuggestions');
        if (!box) return;

        if (val.length < 1) {
            box.style.display = 'none';
            return;
        }

        fetch('products.json')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                var matches = data.filter(function (p) {
                    return p.name.toLowerCase().includes(val);
                });
                if (matches.length > 0) {
                    box.innerHTML = matches.map(function (p) {
                        return '<div onclick="location.href=\'goods.html?id=' + p.id + '\'">' + p.name + '</div>';
                    }).join('');
                    box.style.display = 'block';
                } else {
                    box.style.display = 'none';
                }
            });
    }
</script>

</body>
</html>
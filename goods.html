<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品詳情 - Treat Trader</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .product-main { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
        .tab-btn-group { display: flex; gap: 5px; }
        .tab-btn { flex: 1; padding: 12px; background: #FFECB3; border: none; cursor: pointer; font-weight: bold; border-radius: 10px 10px 0 0; }
        .tab-btn.active { background: #FFD2A6; color: #5C4033; }
        .tab-content { background: white; padding: 20px; display: none; border-radius: 0 0 10px 10px; margin-bottom: 20px; }
        .tab-content.active { display: block; }
        .review-input-area { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .review-input-area textarea { width: 100%; height: 80px; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .review-input-area textarea:disabled { background: #f5f5f5; cursor: not-allowed; }
        .star-rating-input { display: flex; gap: 5px; font-size: 1.5rem; cursor: pointer; }
        .star-rating-input span { color: #ccc; transition: 0.2s; }
        .star-rating-input span.active { color: #e2b007; }
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .page-num { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #ddd; cursor: pointer; }
        .page-num.active { background: #FF7F50; color: white; border-color: #FF7F50; }
        .pagination {display: flex;justify-content: center;gap: 8px;margin-top: 20px;}
        .page-num {padding: 5px 12px;border: 1px solid #ddd;border-radius: 4px;cursor: pointer;user-select: none;}
        .page-num.active {background-color: #5C4033; /* 你的主色調 */color: white;border-color: #5C4033;}
        .page-num:hover:not(.active) {background-color: #f0f0f0;}
        
        @media (max-width: 768px) { .product-main { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="marquee-container">✨ 新年回饋祭最高 10% OFF ｜ 滿 $2500 免運 ｜ 加入會員領取專屬禮券 ✨</div>
    <header>
        <div class="logo" onclick="location.href='index.html'">Treat Trader</div>
        <div class="search-bar">
            <input type="text" id="globalSearch" placeholder="搜尋商品..." oninput="handleSearchInput(this)" onkeypress="handleEnter(event)">
            <button onclick="siteSearch()">搜尋</button>
            <div id="searchSuggestions" class="search-suggestions"></div>
        </div>
        <div class="header-icons">
            <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i></a>
            <a href="login.html" id="avatarLink"><i class="fa-solid fa-circle-user"></i></a>
        </div>
    </header>
    <nav class="main-nav"><a href="index.html">首頁</a><a href="allgoods.html">商品總覽</a><a href="member.html">會員資料</a><a href="team.html">關於我們</a></nav>

    <div class="container">
        <div class="product-main">
            <div id="pImg" class="card" style="height:400px; background:#eee; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:#888;" id="pImg"></div>
            <div>
                <h1 id="pName">載入中...</h1>
                <p id="pPrice" style="font-size: 2rem; color: #FF7F50; margin: 15px 0;">$0</p>
                <div id="pRatingDisplay" style="color: #e2b007; font-size: 1.2rem; margin-bottom: 20px;">★★★★☆ (4.5)</div>
                <div style="display:flex; gap:15px; margin-top: 30px;">
                    <button class="btn" style="flex:1; padding: 15px; font-size:1.1rem;" onclick="addToCart(false)">加入購物車</button>
                    <button class="btn" style="flex:1; background:#5C4033; padding: 15px; font-size:1.1rem;" onclick="addToCart(true)">直接購買</button>
                </div>
            </div>
        </div>

        <div class="tab-btn-group">
            <button class="tab-btn active" onclick="switchTab(event, 'intro')">商品簡介</button>
            <button class="tab-btn" onclick="switchTab(event, 'nutrition')">營養標示</button>
        </div>
        <div id="intro" class="tab-content active"><h3>商品特色</h3><p id="pDesc">載入中...</p></div>
        <div id="nutrition" class="tab-content"><h3>營養成分</h3><p id="pNut">載入中...</p></div>

        <div class="card" style="margin-bottom: 40px; background: transparent; padding:0; box-shadow: none;">
            <h3 style="margin-bottom: 15px;">商品評價</h3>
            <div id="commentList"></div>
            <div class="pagination"><div class="page-num active">1</div></div>
            <div class="card review-input-area">
                <h4>撰寫評論</h4>
                <div style="margin: 10px 0;">
                    <div class="star-rating-input" id="starContainer">
                        <span onclick="setRating(1)">★</span><span onclick="setRating(2)">★</span><span onclick="setRating(3)">★</span><span onclick="setRating(4)">★</span><span onclick="setRating(5)">★</span>
                    </div>
                </div>
                <textarea id="userReview" placeholder="寫下您對這個商品的看法..."></textarea>
                <button class="btn" id="submitReviewBtn" onclick="submitReview()">送出評論</button>
            </div>
        </div>

        <h3 style="margin: 40px 0 20px;">推薦商品</h3>
        <div id="recList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;"></div>
    </div>

    <div class="scroll-top" onclick="window.scrollTo(0,0)">TOP</div>

    <footer>
        <div class="footer-socials"><a href="https://instagram.com" target="_blank"><i class="fa-brands fa-instagram"></i></a><a href="https://facebook.com" target="_blank"><i class="fa-brands fa-facebook"></i></a><a href="https://line.me" target="_blank"><i class="fa-brands fa-line"></i></a><a href="mailto:service@example.com"><i class="fa-solid fa-envelope"></i></a></div>
        <div class="footer-links"><span>聯繫方式</span> | <a href="help.html">幫助中心</a> | <a href="question.html">常見問題</a></div>
        <p class="copyright">© COPYRIGHT 807dorm</p>
    </footer>

    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var pid = urlParams.get('id') || '1';
        var currentProduct = null;
        var currentRating = 5;
        var currentPage = 1; 
        var reviewsPerPage = 2;

        window.onload = function() {
            var user = JSON.parse(localStorage.getItem('tt_currentUser'));
            if(user) {
                document.getElementById('avatarLink').href = "member.html";
            } else {
                document.getElementById('userReview').disabled = true;
                document.getElementById('userReview').placeholder = "請先登入會員以撰寫評論";
                document.getElementById('submitReviewBtn').disabled = true;
                document.getElementById('submitReviewBtn').innerText = "請先登入";
                var starCont = document.getElementById('starContainer');
                starCont.style.pointerEvents = 'none';
                starCont.style.opacity = '0.5';
            }
            setRating(5);
            initFakeData();
        };

        fetch('products.json')
            .then(function(res){ return res.json(); })
            .then(function(data){
                currentProduct = data.find(function(p){ return p.id == pid; });
                if(currentProduct) {
                    document.getElementById('pName').innerText = currentProduct.name;
                    document.getElementById('pPrice').innerText = '$' + currentProduct.price;
                    document.getElementById('pDesc').innerText = currentProduct.desc;
                    document.getElementById('pNut').innerText = currentProduct.nutrition;
                    var imgContainer = document.getElementById('pImg');
                    var imagePath = "images/" + currentProduct.img ;
                    var imgHtml = '<img src="' + imagePath + '" alt="' + currentProduct.name + '" style="width:100%; height:100%; object-fit:cover; border-radius:10px;">';
                    imgContainer.innerHTML = imgHtml;
                    imgContainer.style.background = "none"; // 移除灰色背景
                     // 載入下方的評論和推薦商品
                    loadReviews();
                    loadRecs(data);
                }
            });

        function loadRecs(all) {
            var recs = all.filter(function(p){ return p.id != pid; }).slice(0, 4);
            document.getElementById("recList").innerHTML = recs.map(function(p){
                var recImgPath = "images/" + p.img ;
                return '<div class="card" style="text-align:center; cursor:pointer;" onclick="location.href=\'goods.html?id='+p.id+'\'">'+
                    '<div style="height:150px; margin-bottom:10px; overflow:hidden; border-radius:10px; background:#f9f9f9;">' +
                    '<img src="' + recImgPath + '" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display=\'none\'">' + '</div>'+ 
                    '<h4>' + p.name + '</h4>' +'<p style="color:#FF7F50; font-weight:bold;">$' + p.price + '</p>' +'</div>';
            }).join('');
        }

        function addToCart(goCheckout) {
            var user = JSON.parse(localStorage.getItem('tt_currentUser'));
            if(!user) { alert("請先登入會員後再進行購物！"); location.href = "login.html"; return; }
            if(!currentProduct) return;
            var cart = JSON.parse(localStorage.getItem('tt_cart') || "[]");
            var item = cart.find(function(i){ return i.id == pid; });
            if(item) item.qty++;
            else cart.push({ id: pid, qty: 1, name: currentProduct.name, price: currentProduct.price });
            localStorage.setItem('tt_cart', JSON.stringify(cart));
            if(goCheckout) location.href = 'cart.html';
            else alert("已加入購物車！");
        }

        function setRating(val) {
            currentRating = val;
            var stars = document.getElementById('starContainer').children;
            for(var i=0; i<stars.length; i++) {
                if(i < val) stars[i].classList.add('active');
                else stars[i].classList.remove('active');
            }
        }


        function loadReviews() {
            var allReviews = JSON.parse(localStorage.getItem('tt_reviews') || "[]");
            var pReviews = allReviews.filter(function(r){ return r.pid == pid; });
            var totalPages = Math.ceil(pReviews.length / reviewsPerPage);
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
            var start = (currentPage - 1) * reviewsPerPage;
            var end = start + reviewsPerPage;
            var displayData = pReviews.slice(start, end);
            // 計算並更新上方總評分
            if (pReviews.length > 0) {
                var sum = pReviews.reduce(function(a, b){ return a + b.rating; }, 0);
                var avg = (sum / pReviews.length).toFixed(1);
                var starsHtml = "";
                for(var i=1; i<=5; i++) {
                     if(i <= Math.round(avg)) starsHtml += "★"; else starsHtml += "☆";
                }
                document.getElementById("pRatingDisplay").innerHTML = starsHtml + " (" + avg + ")";
            } else {
                document.getElementById("pRatingDisplay").innerHTML = "☆☆☆☆☆ (0.0)";
            }

            var html = "";
            displayData.forEach(function(r){
                var userStars = "";
                for(var s=1; s<=5; s++) userStars += (s <= r.rating) ? "★" : "☆";
                html += '<div class="card" style="margin-bottom:15px;">' +
                '<div style="display:flex; justify-content:space-between;">' +
                '<strong>'+r.userName+'</strong><span style="color:#888;">'+r.date+'</span></div>' +
                '<div style="color:#e2b007;">'+userStars+'</div>' +
                '<p style="margin-top:8px; color:#555; line-height:1.5;">'+r.content+'</p>' + 
                '</div>';
            });
            document.getElementById("commentList").innerHTML = html || "<p>尚無評論</p>";
            renderPagination(totalPages);
        }

        function renderPagination(total) {
            var container = document.querySelector('.pagination');
            if(!container || total <= 1) { 
                if(container) container.innerHTML = ""; 
                return; 
        }

            var html = "";
            // 上一頁
            if(currentPage > 1) html += '<div class="page-num" onclick="changePage('+(currentPage-1)+')"> < </div>';
            
            // 數字頁碼
            for(var i=1; i<=total; i++) {
                var activeClass = (i === currentPage) ? "active" : "";
                html += '<div class="page-num '+activeClass+'" onclick="changePage('+i+')">'+i+'</div>';
            }

            // 下一頁
            if(currentPage < total) html += '<div class="page-num" onclick="changePage('+(currentPage+1)+')"> > </div>';
            
            container.innerHTML = html;
        }

        // 換頁動作
        function changePage(page) {
            currentPage = page;
            loadReviews(); 
        }

        function submitReview() {
            var newReview = {
                pid: pid,
            };
            var reviews = JSON.parse(localStorage.getItem('tt_reviews') || "[]");
            reviews.unshift(newReview);
            localStorage.setItem('tt_reviews', JSON.stringify(reviews));
            alert("評論已送出！");
            document.getElementById('userReview').value = "";
            currentPage = 1; 
            loadReviews();
        }


        function submitReview() {
            var user = JSON.parse(localStorage.getItem('tt_currentUser'));
            if(!user) return;
            var content = document.getElementById('userReview').value;
            if(!content) { alert("請輸入評論內容"); return; }
            var newReview = { pid: pid, pName: currentProduct.name, userId: user.email, userName: user.name, content: content, rating: currentRating, date: new Date().toLocaleDateString() };
            var reviews = JSON.parse(localStorage.getItem('tt_reviews') || "[]");
            reviews.unshift(newReview);
            localStorage.setItem('tt_reviews', JSON.stringify(reviews));
            alert("評論已送出！");
            document.getElementById('userReview').value = "";
            loadReviews();
        }

        function switchTab(e, id) {
            var tabs = document.querySelectorAll('.tab-btn');
            var contents = document.querySelectorAll('.tab-content');
            for(var i=0; i<tabs.length; i++) tabs[i].classList.remove('active');
            for(var j=0; j<contents.length; j++) contents[j].classList.remove('active');
            e.currentTarget.classList.add('active');
            document.getElementById(id).classList.add('active');
        }

        function handleEnter(e) { if(e.key === 'Enter') siteSearch(); }
        function siteSearch() {
            var val = document.getElementById('globalSearch').value.trim();
            if(!val) return;
            fetch('products.json').then(function(r){ return r.json() }).then(function(data){
                var matches = data.filter(function(p){ return p.name.includes(val); });
                if(matches.length === 0) alert("沒有搜尋到相關商品！");
                else location.href = "allgoods.html?search=" + encodeURIComponent(val);
            });
        }
        function handleSearchInput(input) {
            var val = input.value.toLowerCase();
            var box = document.getElementById('searchSuggestions');
            if(val.length < 1) { box.style.display = 'none'; return; }
            fetch('products.json').then(function(r){ return r.json() }).then(function(data){
                var matches = data.filter(function(p){ return p.name.toLowerCase().includes(val); });
                if(matches.length > 0) {
                    box.innerHTML = matches.map(function(p){ return '<div onclick="location.href=\'goods.html?id='+p.id+'\'">'+p.name+'</div>'; }).join('');
                    box.style.display = 'block';
                } else { box.style.display = 'none'; }
            });
        }

        function initFakeData(){
            var reviews = JSON.parse(localStorage.getItem('tt_reviews') || "[]");
            var pReviews = reviews.filter(function(r){ return r.pid == pid; });
            if (pReviews.length === 0) {
                var fakeData = [
                    { pid: pid, userName: "柳葉瑜", rating: 5, date: "2025/12/20", content: "出貨速度超級快，包裝也很完整！下次一定會再回購，大推！" },
                    { pid: pid, userName: "陳淑美", rating: 4, date: "2026/01/1", content: "整體來說很滿意，但是物流稍微慢了一點點，扣一顆星。食物本身沒問題，很好粗。" },
                    { pid: pid, userName: "丁希望", rating: 5, date: "2025/12/25", content: "這是我最喜歡的零食，台灣能買到真的太好了。客服人員也非常親切有耐心。" },
                    { pid: pid, userName: "潔西卡比獸", rating: 3, date: "2025/01/10", content: "跟圖片實物有點誤差，不過還可以接受。" },
                    { pid: pid, userName: "強哥", rating: 5, date: "2026/01/05", content: "幫家人買的，他們都很喜歡吃。" }
            ];
            reviews = reviews.concat(fakeData);
            localStorage.setItem('tt_reviews', JSON.stringify(reviews));
            console.log("");
        }
    }
    </script>
</body>
</html>